---
title: "UK Trig Points"
author: "Phil Mike Jones"
date: '`r Sys.Date()`'
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

You need a version of `ggplot2` > 2.2.1 to plot `sf` maps with `geom_sf()` which, as of 2018--06--18, means installing the development version:

```{r ggplot}
if (!requireNamespace("devtools")) {
  install.packages("devtools")
}
devtools::install_github("tidyverse/ggplot2", quiet = TRUE)
```

Load packages for reading in the files, data wrangling, and plotting on a map.

```{r packages}
library("tidyverse")
library("sf")
```

Obtain the trig points from the [Ordnance Survey](https://www.ordnancesurvey.co.uk/gps/legacy-control-information/triangulation-stations) and unzip.

```{r obtain-data}
dir.create("inst/extdata/", recursive = TRUE, showWarnings = FALSE)

if (!file.exists("inst/extdata/CompleteTrigArchive.zip")) {
  download.file(
    "https://www.ordnancesurvey.co.uk/docs/gps/CompleteTrigArchive.zip",
    destfile = "inst/extdata/CompleteTrigArchive.zip"
  )
}

if (!file.exists("inst/extdata/CompleteTrigArchive.csv")) {
  unzip(
    "inst/extdata/CompleteTrigArchive.zip",
    exdir = "inst/extdata/"
  )  
}
```

Load the trig points:

```{r load-trig-points}
trig = read_csv("inst/extdata/CompleteTrigArchive.csv")
```

The trig points file contains all types of trig points.
I'm only interested in those that are pillars (the archetypal ['Hotine' pillar](https://en.wikipedia.org/wiki/Triangulation_station#United_Kingdom)).

```{r filter-pillar}
trig =
  trig %>%
  filter(`TYPE OF MARK` == "PILLAR") %>% 
  select(-`TYPE OF MARK`)
```

I'm also not interested in those that are destroyed, so I remove these.
The data file we downloaded is no longer being maintained by Ordnance Survey, so some of the pillars left may also be destroyed, but there's nothing I can do about this for now.

```{r filter-destroyed}
trig =
  trig %>% 
  filter(`DESTROYED MARK INDICATOR` == 0L) %>% 
  select(-`DESTROYED MARK INDICATOR`)
```

Next convert the table to an `sf` object with geometry for plotting.
Here I also set the [CRS](https://en.wikipedia.org/wiki/Spatial_reference_system) to the British National Grid so it plots correctly and so I can transform the points later:

```{r convert-sf}
trig =
  trig %>% 
  st_as_sf(coords = c("EASTING", "NORTHING"), crs = 27700)
```

Plot a sample of points (otherwise it takes forever) to confirm the points are where they should be:

```{r plot-trig}
set.seed(42)
trig %>% 
  sample_frac(size = 0.05) %>% 
  ggplot(.) +
  geom_sf()
```

That roughly looks like the UK.
So far, so good.

Now, I want to concentrate on those points around my home (Sheffield).
The coordinates of the trig points are given in Easting and Northing, using the [British National Grid](https://en.wikipedia.org/wiki/Ordnance_Survey_National_Grid) (not the high voltage one).
The centre of Sheffield is approximately 435100 east and 387100 north.
I want to select trig points within about an hour of here, which is about 40km.

```{r filter-sheffield}
sheffield =
  data.frame(
    easting  = 435100,
    northing = 387100,
    stringsAsFactors = FALSE
  ) %>% 
  st_as_sf(coords = c("easting", "northing"), crs = 27700)

sheffield =
  trig %>% 
  filter(st_within(., st_buffer(sheffield, 40000), sparse = FALSE))
```

```{r plot-sheffield-trigs}
sheffield %>% 
  ggplot(.) +
  geom_sf()
```

Before I export these I first need to transform these points to the [Pseudo--Mercator projection](https://epsg.io/3857) so that they work with online mapping tile providers:

```{r sheffield-crs}
sheffield =
  sheffield %>% 
  st_transform(crs = 3857)
```

Now to export for use in other GIS software:

```{r export}
dir.create("export/", showWarnings = FALSE)
if (!file.exists("export/sheffield_trigs.shp")) {
  sf::st_write(
    sheffield,
    dsn = "export",
    layer = "sheffield_trigs.shp",
    driver = "ESRI Shapefile"
  )
}
```
